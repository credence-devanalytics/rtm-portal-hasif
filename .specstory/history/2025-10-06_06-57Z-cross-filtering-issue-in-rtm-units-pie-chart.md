<!-- Generated by SpecStory -->

<!-- vscode Session fe8942bb-b023-4c40-9d35-edb405101da3 (2025-10-06 06:57Z) -->

# Cross-filtering issue in RTM Units Pie Chart (2025-10-06 06:57Z)

_**User (2025-10-06 07:02Z)**_

the cross filtering is not working, it didnt changed the whole page'

---

_**Assistant (copilot/claude-sonnet-4.5)**_

I'll help you investigate why the cross-filtering isn't working. Let me first check how this component is being used in the parent component and how the filtering mechanism is implemented. 

Now let me check the parent page component to see how the filtering is implemented: 

Now let me search for the `handleGlobalFilterChange` function: 

Now let me check where the RTMUnitsPieChart is being used with the props: 

Perfect! Now I can see the issue. The problem is in the `handleGlobalFilterChange` function. It has a **toggle behavior** - when you click the same filter value again, it sets it to `null`. This is causing the cross-filtering to not work as expected.

Looking at line 325:
```typescript
[filterType]: filterValue === prev[filterType] ? null : filterValue,
```

This means if you click on the same unit again, it toggles it off. But the real issue is that this toggle behavior might be interfering with the expected filtering behavior. Let me check the console to understand better, and also verify the transform function: 

Now I see the problem! The filtering logic in the parent component has special handling for certain unit values like "tv", "berita", "radio", "official", but when you click on a pie slice in `RTMUnitsPieChart`, it's passing the **actual unit name** from the data (like "TV", "Berita", "Radio"), not these lowercase special keys.

Looking at your `RTMUnitsPieChart.tsx`:
- Line 32: `transformUnitName` transforms "News" to "Berita"
- Line 43: `onFilterChange("unit", unitValue)` - passes the transformed unit name (e.g., "Berita", "TV", "Radio")

But in the parent's filtering logic (lines 232-260), it expects lowercase values like:
- "tv" (not "TV")
- "berita" (not "Berita") 
- "radio" (not "Radio")

The mismatch is causing the filter to not work properly. Let me fix this: 
```

```


Now I also need to update the `isUnitFiltered` function to properly check if a unit is filtered by converting it to the filter value format: 
```

```


Wait, there's an issue - `unitToFilterValue` is defined inside the component but after `isUnitFiltered` is defined. I need to move the function definition before it's used, or use a different approach. Let me fix this: 

Good! The function is now in the right place. However, `useCallback` has a dependency issue - it's using `unitToFilterValue` function which is not in the dependencies array. Let me fix this by using a simpler approach without useCallback or by including all dependencies: 
```

```


Now, there's one more potential issue. Looking at the parent component's filtering logic again, I need to verify that the filtering is working for exact matches. Let me also check if there's a case-sensitivity issue. Let me look at the parent filtering logic more carefully:

The parent expects:
- "tv" (lowercase)
- "berita" (lowercase)
- "radio" (lowercase)
- "official" (lowercase)

But it does **substring matching** for these special cases. However, for a direct match from the pie chart, we need to make sure we're sending the lowercase version.

Actually, looking more closely at the parent's filter logic (lines 232-260 in page.tsx), I see the issue! The parent is checking for these **special tab values** ("tv", "berita", "radio", "official") and doing substring matching. But when we click on the pie chart, we should be sending the **exact unit value** if it's not one of these special cases.

Let me look at what unit values actually exist in the data. But first, let me check if there might be additional issues. Let me also verify there's not a case where the filter is being applied but the data transformation is using the wrong field: 

Perfect! Now I can see the issue. The `transformRTMData` function sets the unit values to:
- "Radio"
- "TV"
- "News"
- "Official"

These are **capitalized** values. But the parent component's filter logic expects **lowercase** values like "tv", "berita", "radio", "official".

So when we filter in the parent component, it's checking:
```javascript
if (unit === "tv") {
  if (!(item.unit === "TV" || item.unit?.toLowerCase().includes("tv") || item.platform === "YouTube"))
```

This works because it checks `item.unit === "TV"` OR `item.unit?.toLowerCase().includes("tv")`.

So the actual issue is that when clicking from the pie chart, we need to ensure the **correct filter value** is being passed. The mapping I created should work, but let me double-check one more thing - the parent component might be doing **case-sensitive** equality checks in some places.

Actually, looking more carefully at the parent's filtering logic, I see that it's checking `globalFilters.unit` against strings like "tv", "berita", "radio", "official" (lowercase). So our fix is correct - we need to send lowercase values.

However, there's another issue I noticed. The pie chart transforms "News" to "Berita" for display, but the actual data might have "News" as the unit value. Let me verify the logic is consistent:

In the parent component (line 232-260), when `globalFilters.unit === "berita"`, it checks:
```javascript
if (!(item.unit === "News" || item.unit?.toLowerCase().includes("news") || item.unit?.toLowerCase().includes("berita")))
```

So it expects the data to have `item.unit === "News"` (capitalized), and the filter value to be "berita" (lowercase). This matches what we're doing!

Now let me make sure the parent component properly handles the case where we might send an exact unit match (not one of the special cases). Looking at the parent's filter logic, if the unit doesn't match "overall", "official", "tv", "berita", or "radio", it falls through to the other filters and doesn't filter by unit at all! This is a bug.

Let me check if there's an else clause: 

I see! The parent filter logic only handles the special cases ("overall", "official", "tv", "berita", "radio"). If you click on a unit that doesn't match these (like "Other"), the filter won't do anything because there's no else clause to handle other unit values.

Also, I notice the filter logic has a potential bug: if the unit doesn't match any of the special cases, it doesn't filter at all - it just continues to the next filters. This means clicking on an "Other" unit won't filter anything.

Let me update the parent component's filter logic to add an else clause that handles exact unit matches: 
```

```


Good! Now let me also add some console logging to help debug the filtering: 
```

```


Now let's add logging to see the filtered data: 
```

```

```

```


Perfect! Now let's create a summary of what we fixed:

## Summary of Changes

I've identified and fixed the cross-filtering issue in your RTM Units Pie Chart. The problem was a **mismatch between the unit values** sent from the pie chart and what the parent component's filter logic expected.

### Issues Found:

1. **Case mismatch**: The pie chart was sending capitalized unit names (e.g., "TV", "Berita", "Radio"), but the parent component's filter logic expected lowercase values (e.g., "tv", "berita", "radio").

2. **Missing else clause**: The parent component's filter logic didn't handle unit values that weren't one of the special cases ("tv", "berita", "radio", "official"), so clicking on "Other" or any other unit wouldn't filter anything.

### Changes Made:

#### 1. **`RTMUnitsPieChart.tsx`** - Added unit value conversion:
   - Created `unitToFilterValue()` function to convert display unit names to the lowercase filter values expected by the parent
   - Updated `handlePieClick()` and `handleStatCardClick()` to convert unit values before calling `onFilterChange`
   - Updated `isUnitFiltered()` to properly check if a unit is currently filtered by converting to the filter value format
   - Added debug logging to track filter changes

#### 2. **`page.tsx`** (Parent component) - Fixed filter logic:
   - Added an `else` clause to handle non-special unit values with case-insensitive exact matching
   - Added console logging to help debug filter changes and see filtered data counts

### How it works now:

1. When you click on a pie slice or unit card in `RTMUnitsPieChart`, it converts the unit name to the correct filter format (e.g., "Berita" → "berita", "TV" → "tv")
2. The parent component receives the filter value and updates `globalFilters.unit`
3. The filtering logic now properly handles all cases:
   - Special units: "tv", "berita", "radio", "official" (with fuzzy matching)
   - Other units: Exact case-insensitive match
4. All charts on the page receive the filtered data and update accordingly
5. Visual feedback shows which unit is currently filtered with highlighting and opacity changes

The cross-filtering should now work correctly across all charts on the dashboard! You can test it by clicking on different units in the pie chart and watching the console logs to see the filtering in action.

---

_**User (2025-10-06 07:08Z)**_

i think we need to predefine the colours for each unit so that this will not happen

---

_**Assistant (copilot/claude-sonnet-4.5)**_

You're absolutely right! The issue in the screenshot shows that the colors are being reassigned when data is filtered, causing the same unit to have different colors. We need to create a **predefined color mapping** based on unit names so each unit always gets the same color regardless of filtering.

Let me fix this: 
```

```


Now I need to replace all uses of the `colors` array with the new `getUnitColor` function: 
```

```

```

```

```

```

```

```


Perfect! Now let's verify there are no more errors: 

Excellent! Now let's create a visual summary comment at the top of the color mapping to make it easy to see what colors are assigned to which units: 
```

```


Perfect! Now let me create a summary of what we've done:

## ✅ Fixed: Predefined Color Mapping for Units

I've successfully implemented a **predefined color mapping system** for the RTM Units Pie Chart. This ensures that each unit **always gets the same color**, regardless of filtering or data changes.

### What Changed:

#### **Before** ❌
- Colors were assigned based on array index order
- When data was filtered, the order changed
- Same unit could appear with different colors (as shown in your screenshot)

#### **After** ✅
- Each unit has a **dedicated color** defined in a color map
- Colors remain consistent across all filtering operations
- Professional and predictable color scheme

### Color Assignments:

| Unit | Color | Hex Code |
|------|-------|----------|
| 🔵 **TV** | Blue-purple | `#4E5899` |
| 🟢 **Berita/News** | Green | `#28a745` |
| 🟠 **Radio** | Orange | `#ff9705` |
| 🟣 **Official** | Purple | `#6f42c1` |
| 🟧 **Other** | Orange variant | `#fd7e14` |
| 🔷 **Default** | Teal | `#20c997` |

### Key Improvements:

1. **Consistent Colors**: Each unit will always have the same color, whether you're viewing all data or filtered data
2. **Better UX**: Users can learn to associate specific units with specific colors
3. **Fallback System**: Includes fallback colors for any unexpected unit types
4. **Channel Colors**: Outer ring (channels) still use shaded variations of their parent unit's color for visual hierarchy

Now when you filter the data, the colors will remain stable and consistent! TV will always be blue-purple, Radio will always be orange, Berita will always be green, etc. 🎨

---

